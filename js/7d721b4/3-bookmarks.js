Sydney.bookmarks=function(){function l(a){r||(null!==d&&(clearTimeout(d),d=null),r=!0,a=a||!1,Sydney["user-data"].getOnlineData("bookmarks",v,function(b,j,D){if("success"===b){var g=j.activeBookmarks,d=j.deletedBookmarks;"array"===$.type(g)&&0===g.length&&(g={});var f;a:{b=c;j=g;for(f in b)if(b.hasOwnProperty(f)&&(!j.hasOwnProperty(f)||Math.abs(b[f].ts-j[f].ts)>E)){f=!1;break a}for(f in j)if(j.hasOwnProperty(f)&&!b.hasOwnProperty(f)){f=!1;break a}f=!0}f?(m(!a,!1),console.log("[Kirjanmerkkisync] Paikallinen ja online samat"),
Sydney.events.trigger("bookmarks","bookmarksSyncReady"),p(!1)):($.each(g,function(a){_.isUndefined(c[a])?c[a]=g[a]:c[a]!==g[a]&&g[a].ts>c[a].ts&&(c[a].ts=g[a].ts)}),$.each(d,function(a){_.isUndefined(h[a])?h[a]=d[a]:h[a]!==d[a]&&d[a].ts>h[a].ts&&(h[a].ts=d[a].ts)}),$.each(c,function(a){!_.isUndefined(h[a])&&h[a].ts>c[a].ts&&delete c[a]}),m(!0,!0,D,function(){console.log("[Kirjanmerkkisync] Synkronointi onnistui");Sydney.events.trigger("bookmarks","bookmarksSyncReady");p(!0)}))}else"no-saved-data"===
b?(console.log("[Kirjanmerkkisync] Ei aikaisempaa online-dataa, tallennetaan"),Sydney.events.trigger("bookmarks","bookmarksSyncReady"),m(!a,!0,null),p(!1)):"network-problem"===b&&(console.log("[Kirjanmerkkisync] Verkko-ongelma"),Sydney.events.trigger("bookmarks","bookmarksSyncReady"),m(!a,!1,null),p(!1))}))}function w(a){delete c[a];h[a]={articleId:a,ts:Sydney.globals.getTimestamp()};n();Sydney.events.trigger("bookmarks","bookmarksSyncReady");m(!0,!1);null!==d&&clearTimeout(d);d=setTimeout(function(){l()},
3E3)}function p(a){a&&n();r=!1;null===d&&(d=setTimeout(function(){d=null;l()},1E3*F))}function m(a,b,j,d){var g={activeBookmarks:c,deletedBookmarks:h};_.isUndefined(d)&&(d=function(){});b&&Sydney["user-data"].setOnlineData("bookmarks",g,j,v,d);a&&Sydney["user-data"].setOfflineData("bookmarks",g)}function G(a,b){k=b;Sydney["list-nav"].setNewSettings(e,s[k]);n()}function x(a){y&&(Sydney["list-nav"].setPreviousActiveItemNotActive(e,"category"===k?3:2),Sydney["list-nav"].setListItemActive(e,{id:a},!0,
!0,!0))}function H(){q.toggleClass("active");Sydney["list-nav"].toggleEditMode(e);q.hasClass("active")&&Sydney["list-nav"].setListItemsOfLevelActive(e,2,!0)}function u(a){w(a.id)}function z(a){Sydney.article.openArticleById(a.id)}function n(){var a;a=[{title:t("bookmarks.title"),children:[]}];if("category"===k){var b=[];$.each(c,function(a){b.push(a)});b.length&&(a[0].children=A(b,!0));Sydney["list-nav"].renderAndShowList(e,a,!0)}else"alphabet"===k&&($.each(c,function(b){a[0].children.push({id:b,
rootid:Sydney.data.getRootItemId(b),title:Sydney.data.getItemMenuTitle(b)})}),B(a[0].children),Sydney["list-nav"].renderAndShowList(e,a));x(Sydney.article.getActiveArticleId())}function A(a,b,d){var c=[],g,h,f=Sydney.data.getMenuData(),e;for(e=0;e<f.length;e++)c.push({id:f[e].id,title:f[e].title,children:[]});$.each(a,function(a,b){g=Sydney.data.getRootItemId(b);h=_.findIndex(c,function(a){return a.id===g});if(-1===h)return!0;c[h].children.push({id:b,title:Sydney.data.getItemMenuTitle(b)})});for(e=
c.length-1;0<=e;e--)0===c[e].children.length&&(c[e].hidden=!0);b&&$.each(c,function(a,b){B(b.children)});d&&$.each(c,function(a,b){b.sidetext="("+b.children.length+")"});return c}function B(a){a.sort(function(a,c){return a.title>c.title?1:a.title<c.title?-1:0})}var e,C,q,F=30,r=!1,d=null,y=!1,s,k="category",c={},h={},v=[{setting:"use-time-ago-conversion",property:"ts"}],E=10;return{init:function(){$("#bookmarks");e=$("#bookmarks-list");C=$("#bookmarks-grouping-list");$("#bookmarks-add-button");q=
$("#bookmarks-edit-button");Sydney.events.on("article","afterArticleOpen",function(a,b){x(b)});Sydney.events.on("settings","bookmarksOrderByChanged",G);q.click(H);e.on("click",".bookmark-delete-button",u)},start:function(){s={category:{levels:{1:{css_class:"header-list-item",active:!0,allow_multiple_actives:!0,expandable:!0,children_placeholder_title:t("bookmarks.no_bookmarks_text"),children_placeholder_class:"article-list-item",preserve_actives:!0},2:{css_class:"topic-list-item",active:!0,allow_multiple_actives:!0,
expandable:!0,preserve_actives:!0},3:{css_class:"article-list-item",active:!1,allow_multiple_actives:!1,expandable:!1,click_callback:z,removable:!0,remove_callback:u}}},alphabet:{levels:{1:{css_class:"header-list-item",active:!0,allow_multiple_actives:!0,expandable:!0,children_placeholder_title:t("bookmarks.no_bookmarks_text"),children_placeholder_class:"article-list-item"},2:{css_class:"article-list-item",active:!1,allow_multiple_actives:!1,expandable:!1,click_callback:z,removable:!0,remove_callback:u}}}};
Sydney["list-nav"].createList(e,s[k]);Sydney["list-nav"].setListItemActive(C,{prop:k},!0,!1);Sydney["user-data"].getOfflineData("bookmarks",function(a){null!==a?(c=a.activeBookmarks,h=a.deletedBookmarks,y=!0,n(),l(!0)):l(!1)})},addToBookmarks:function(a){Sydney.data.getRootItemId(a);c[a]={ts:Sydney.globals.getTimestamp()};n();m(!0,!1);null!==d&&clearTimeout(d);d=setTimeout(function(){l()},3E3)},removeBookmark:w,isInBookmarks:function(a){return!_.isUndefined(c[a])},syncBookmarks:l,getListItemsGroupedByRootCats:A}}();
